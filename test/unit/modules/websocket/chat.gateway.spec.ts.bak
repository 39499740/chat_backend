import { Test, TestingModule } from '@nestjs/testing';
import { ChatGateway } from '@/modules/websocket/chat.gateway';

describe('ChatGateway (Simplified)', () => {
  let gateway: ChatGateway;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [ChatGateway],
    }).compile();

    gateway = module.get<ChatGateway>(ChatGateway);
  });

  afterEach(() => {
    jest.clearAllMocks();
  });

  describe('Gateway initialization', () => {
    it('should be defined', () => {
      expect(gateway).toBeDefined();
      expect(gateway.server).toBeDefined();
      expect(gateway.logger).toBeDefined();
    });
  });

  describe('Online users management', () => {
    it('should initialize onlineUsers map', () => {
      expect((gateway as any).onlineUsers).toBeInstanceOf(Map);
      expect((gateway as any).onlineUsers.size).toBe(0);
    });

    it('should initialize userConversations map', () => {
      expect((gateway as any).userConversations).toBeInstanceOf(Map);
      expect((gateway as any).userConversations.size).toBe(0);
    });
  });

  describe('getUserIdBySocket', () => {
    it('should return userId for valid socket', () => {
      const mockSocket: any = { id: 'socket-1' };
      const mockUser = { socket: mockSocket, userId: 'user-1' };

      (gateway as any).onlineUsers.set('user-1', mockUser);

      const userId = (gateway as any).getUserIdBySocket('socket-1');

      expect(userId).toBe('user-1');
    });

    it('should return null for invalid socket', () => {
      const userId = (gateway as any).getUserIdBySocket('invalid-socket-id');

      expect(userId).toBeNull();
    });

    it('should return null when onlineUsers is empty', () => {
      const mockSocket: any = { id: 'socket-1' };
      (gateway as any).onlineUsers.clear();

      const userId = (gateway as any).getUserIdBySocket('socket-1');

      expect(userId).toBeNull();
    });
  });

  describe('notifyFriendsStatus', () => {
    it('should call server.to for each online user', () => {
      const mockServer: any = {
        to: jest.fn().mockReturnThis(),
      };

      const mockUsers: any = {
        socket1: { socket: { id: 'socket-1' } },
        socket2: { socket: { id: 'socket-2' } },
      };

      mockServer.to = jest.fn().mockReturnValue(mockServer);

      (gateway as any).server = mockServer;
      (gateway as any).onlineUsers.set('user-1', mockUsers.socket1);
      (gateway as any).onlineUsers.set('user-2', mockUsers.socket2);

      (gateway as any).notifyFriendsStatus('user-1', 'online');

      expect(mockServer.to).toHaveBeenCalledTimes(2);
    });

    it('should handle empty online users', () => {
      const mockServer: any = {
        to: jest.fn(),
      };

      mockServer.to = jest.fn().mockReturnValue(mockServer);

      (gateway as any).server = mockServer;
      (gateway as any).onlineUsers.clear();

      (gateway as any).notifyFriendsStatus('user-1', 'online');

      expect(mockServer.to).not.toHaveBeenCalled();
    });
  });

  describe('handleGetOnlineUsers', () => {
    it('should return online users list', async () => {
      const mockClient: any = {
        id: 'client-1',
        emit: jest.fn(),
      };

      (gateway as any).server = {
        to: jest.fn().mockReturnThis(),
      };

      (gateway as any).onlineUsers.set('user-1', { userId: 'user-1', socket: mockClient });
      (gateway as any).onlineUsers.set('user-2', { userId: 'user-2', socket: { id: 'socket-2' } });

      await gateway.handleGetOnlineUsers(mockClient);

      expect(mockClient.emit).toHaveBeenCalledWith('online_users', {
        users: ['user-1', 'user-2'],
        currentUserId: 'user-1',
      });
    });

    it('should handle get online users for unknown user', async () => {
      const mockClient: any = {
        id: 'client-1',
        emit: jest.fn(),
      };

      (gateway as any).server = {
        to: jest.fn().mockReturnThis(),
      };

      (gateway as any).onlineUsers.clear();

      await gateway.handleGetOnlineUsers(mockClient);

      expect(mockClient.emit).toHaveBeenCalledWith('online_users', {
        users: [],
        currentUserId: null,
      });
    });
  });

  describe('handleGetConversationMembers', () => {
    it('should return conversation members', async () => {
      const mockClient: any = {
        id: 'client-1',
        emit: jest.fn(),
      };

      (gateway as any).server = {
        to: jest.fn().mockReturnThis(),
      };

      const mockUsers: any = {
        socket1: { socket: { id: 'socket-1' } },
        socket2: { socket: { id: 'socket-2' } },
        socket3: { socket: { id: 'socket-3' } },
      };

      (gateway as any).server = mockServer;
      (gateway as any).onlineUsers.set('user-1', { userId: 'user-1', socket: mockUsers.socket1 });
      (gateway as any).onlineUsers.set('user-2', { userId: 'user-2', socket: mockUsers.socket2 });
      (gateway as any).onlineUsers.set('user-3', { userId: 'user-3', socket: mockUsers.socket3 });

      await gateway.handleGetConversationMembers(mockClient, { conversationId: 'conv-1' });

      expect(mockClient.emit).toHaveBeenCalledWith('conversation_members', {
        conversationId: 'conv-1',
        onlineMembers: expect.arrayContaining('user-2', 'user-3'),
        offlineMembers: expect.arrayContaining('user-1'),
      });
    });

    it('should exclude self from online members', async () => {
      const mockClient: any = {
        id: 'client-1',
        emit: jest.fn(),
      };

      (gateway as any).server = {
        to: jest.fn().mockReturnThis(),
      };

      const mockUsers: any = {
        socket1: { socket: { id: 'socket-1' } },
        socket2: { socket: { id: 'socket-2' } },
      };

      (gateway as any).server = mockServer;
      (gateway as any).onlineUsers.set('user-1', { userId: 'user-1', socket: mockUsers.socket1 });
      (gateway as any).onlineUsers.set('user-2', { userId: 'user-2', socket: mockUsers.socket2 });

      await gateway.handleGetConversationMembers(mockClient, { conversationId: 'conv-1' });

      expect(mockClient.emit).toHaveBeenCalledWith('conversation_members', {
        conversationId: 'conv-1',
        onlineMembers: ['user-2'],
        offlineMembers: [],
      });
    });
  });
});
